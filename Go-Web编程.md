# 第一章 Go与Web应用

阐述Go用于开发Web应用的优势，以及介绍HTTP协议、Web应用等关键概念。

## Go基础优势

Go本身的基础优势：

- 提供过程式编程的特性，也支持函数式编程的特性
- 内置对并发编程的支持
- 现代化的包管理系统
- 现代化的垃圾收集特性
- 强大的标准库

## Web应用特性

一个大规模扩拓展的Web应用具备的特性：

- 可拓展
- 模块化
- 可维护
- 高性能

那么Go在满足这些特性上有何优势？

### 可拓展

可拓展，意味着可以通过简单、快速地提升应用的性能以便处理更多的请求。有两种方式可以对性能进行拓展。

- 垂直拓展。提升单台设备的CPU数量或者性能。
- 水平拓展。通过增加计算机数量提升性能。

在垂直拓展上，Go拥有非常优异的并发编程支持，只需要一个操作系统线程，就可以通过调度来高效运行数十万个goroutine。

在水平拓展上，Go也可以通过在多个Web应用之上架设代理来进行高效的水平拓展。同时，因为Go Web应用会被编译成不包含任何动态依赖关系的静态二进制文件，所以可以将其安装到没有安装Go语言的系统里，以简单一致的方式部署应用。

### 模块化

Web应用由可替换的组件组成，这样做使开发者更容易修改。另一个好处是可以通过复用模块化的组件来降低软件开发所需的费用。

Go可以通过接口机制来实现动态类型匹配，用以模块化。同时，Go还支持函数式编程常见的特性，比如使用函数作为值、闭包，这些特性能允许开发者使用已有的函数来构建新的函数，从而构建出更模块化的代码。

### 可维护

Go的设计鼓励良好的软件工程实践，拥有简洁且极具可读性的语法以及灵活且清晰的包管理系统。它具有一整套优秀的工具，比如go fmt可以格式化代码，go doc可以管理注释文档，go test可以进行测试。Go还提供了Web应用测试工具，可以模拟出一个Web服务器，对该服务器生成的响应进行记录。

### 高性能

高性能意味着不仅能够在短时间内处理大量请求，还意味着能够快速地对客户端进行响应。

Go语言的一个设计目标是提供接近于C语言的性能，具有非常优秀的性能。Go程序会被编译成本地码(native code)，意味着比解释型语言要快。同时，goroutne对并发编程提供了非常好的支持。

## Web应用的定义

web服务器：监视特定的目录，在接收到请求时返回位于目录中的文件。比如httpd, Apache。

web应用：会对请求进行处理，并执行应用程序中预先设定好的操作，然后返回文件/结果。

web服务器是静态的，web应用是动态的，可以将web服务器理解成是特殊的web应用。

本文的web应用定义，需要满足两个要求。第一，必须向发送命令请求的客户端返回HTML，客户端则会向用户展示渲染后的HTML。第二，向客户端传送数据时必须使用HTTP协议。

web服务：若向客户端返回的不是HTML，而是其他格式的数据，就认为是web服务。

## Web应用的诞生

Web服务器一开始只处理静态HTML，后来也包含动态生成的内容。

通用网关接口（Common Gateway Interface, CGI）是早起尝试动态生成HTML内容的技术之一。

CGI是一个简单的接口，它允许Web服务器与一个独立运行于Web服务器进程之外的进程进行对接。通过CGI与服务器进行对接的程序通常被称为CGI程序，这种程序可以使用任何编程语言编写，这也是被称为"通用"接口的原因。向CGI程序传递输入参数是通过设置环境变量来完成的，CGI程序在运行之后还将向标准输出返回结果，而服务器则会将这些结果传送至客户端。

与CGI同期出现的还有服务端包含(server-side includes, SSI)技术。这种技术允许开发者在HTML文件中包含一些指令，当客户端请求一个HTML文件时，服务端在返回这个文件之前，会先执行文件中包含的指令，并将文件中出现的指令的位置替换成这些指令的执行结果。SSI最常见的用法是在HTML文件中包含其他被频繁使用的文件，又或者将整个网站都会出现的页面首部以及尾部的代码嵌入HTML文件中。SSI演化的最终结果就是在HTML里面包含更为复杂的代码，并使用更强大的解释器，由此衍生出了PHP、ASP、JSP等一系列非常成功的引擎。

## HTTP请求

安全：如果一个HTTP方法只要求服务器提供信息而不会对服务器的状态做任何修改，那么这个方法就是安全的。GET、HEAD、OPTIONS和TRACE都是安全的，而POST、PUT和DELETE不是安全的。

幂等：如果一个HTTP方法在使用相同的数据进行第二次调用的时候，不会对服务器的状态造成任何改变，那么这个方法就是幂等的。根据安全的方法的定义，可知安全的方法是天生幂等的。PUT和DELETE虽然不安全，但却是幂等的，这是因为第二次调用时不会修改服务器的状态。需要注意的是，服务器报错并意味着不幂等，比如多次DELETE一个资源，可能会报错，但是服务器的状态不变，它就是幂等的。因为POST请求是否会改变服务器状态是由服务器决定的，所以POST方法既不安全也非幂等。

浏览器对请求方法的支持：GET方法是最基本的方法，所有浏览器都支持。POST方法从HTML 2.0开始可以通过添加HTML表单来实现，但HTML不支持GET和POST之外的其他方法。浏览器除了支持HTML，还支持XHR(XMLHttpRequest)，以提供对PUT方法和DELETE方法的支持。XHR是一系列浏览器API，这些API通常由JavaScript包裹，实际上XHR是一个名为XMLHttpRequest的浏览器对象。XHR允许程序员向浏览器放HTTP请求，它并不如它的名字所暗示那样局限于XML，还支持JSON、纯文本等任何格式的数据。

## Web应用的组成部分

web应用有以下任务：

1. 通过HTTP协议，以HTTP请求报文的形式获取客户端输入
2. 对HTTP请求报文进行处理，并执行必要的操作
3. 生成HTML，并以HTTP响应报文的形式将其返回给客户端

为了完成这些任务，Web应用分成了处理器(handler)和模板引擎(template engine)。

### 处理器

处理器用于接受和处理客户端发来的请求，然后调用模板引擎生成HTML并把数据填充回传到客户端的响应报文中。用MVC(Model-View-Controller)模式来讲，处理器既是控制器(Controller)又是模型(Model)。

### 模板引擎

模板引擎通过模板和数据来生成返回给客户端的HTML，它是由早起的SSI技术演变而来的。

模板引擎可以分为静态模板和动态模板。

静态模板是一种夹杂着占位符的HTML，静态模板引擎通过将静态模板中的占位符替换成相应的数据来生成最终的HTML。静态逻辑通常不包含任何逻辑代码，因此被称为无逻辑模板。CTemplate和Mustache属于静态模板引擎。

动态模板除了包含HTML和占位符之外，还包含一些编程语言结构，如条件语句、迭代语句和变量。JSP(JavaServer Pages), ASP(Active Server Pages)属于动态模板引擎。PHP刚诞生时看上去也像是一种动态模板，后来才逐渐发展成为一门编程语言。

# 第二章 例子展示

展示如何使用Go构件一个典型的Web应用。

多路复用器：用于对请求进行检查，并将请求重定向至正确的处理器进行处理。

## 模板

可以使用模板生成HTML响应。模板文件中可以包含特定的嵌入命令，称为动作(action)，动作在HTML文件里面会被`{{`和`}}`包围。模板文件需要进行语法分析，然后创建出响应的模板。

常用模板动作：

- `define <xxx>` 用于定义模板名称
- `end` 表示结束
- `template <xxx> .`  引用其他模板

在模板文件中，除了可以访问变量的字段外，还可以调用变量的方法。

## PostgreSQL

PostgreSQL的安装和使用：

- 安装：`sudo apt install postgresql postgresql-contrib`
- 使用：`sudo su postgres`
- 以用户gwp进入管理界面：`psql -U gwp`
- 导入数据库：`psql -f setup.sql -d chitchat`



# 第三章 接收请求

详细展示使用net/http包接收HTTP请求的方法。读者将学会如何编程Go Web服务器监听HTTP请求，以及如何使用处理器和处理器函数处理这些请求。

许多流行的Web框架基于的两大官方package是net/http和html/template。它们基于这两个package做了许多有用的特性，开发者可以学习好的框架、约定和模式，但是同时也应该深入学习框架底层概念和基础设施，这样才能对编程有更深入的理解，从而避免陷阱、理清思路，不盲目使用框架。

## X.509

X.509：是为公钥基础设施制定的一个标准，这个标准包含了公钥证书的标准格式。

一个X.509证书（简称SSL证书）实际上是一个经过编码的ASN.1(Abstract Syntax Notation One，抽象语法表示法/1)格式的电子文档。ASN.1既是一个标准，也是一种表示法。

X.509证书可以使用多种格式编码。其中一种是BER(Basic Encoding Rules，基本编码规则)，BER格式指定了一种自解释并且自定义的格式用于对ASN.1数据结构进行编码。而DER格式则是BER的一个子集，DER只提供了一种编码ASN.1值的方法，这种方法被广泛应用于密码学当中，尤其是对X.509证书进行加密。

SSDL证书可以以多种不同的格式保存。其中一种是PEM(Privacy Enhanced Email，隐私增强邮件)格式，这种格式会对DER格式的X.509证书实施Base64编码，并且以BEGIN CERTIFICATE开头，以END CERTIFICATE结尾。

## 处理器与处理器函数

处理器：拥有ServeHTTP方法的接口

处理器函数：实现了ServeHTTP方法的函数

日志记录、安全检查和错误处理等通用操作被成为横切关注点(cross-cutting concern)，为了防止代码重复和代码依赖关系，不希望将这些操作和正常的代码放在一起，因此，可以使用串联技术分隔代码中的横切关注点。

串联技术就是将多个处理器串联起来，也称为管道处理(pipeline processing)。

## ServeMux

最小惊讶原则：也称最小意外原则，是设计包括软件在内的一切事物的一条通用规则，它指的是我们在进行设计的时候，应该做那些合乎常理的事情，使事物的行为显而易见，始终如一并且合乎常理。

绑定ServerMux时，当绑定的URL不以`/`结尾时，意味着需要完全匹配。假如以`/`结尾，意味着最长前缀匹配。

比如绑定了`/hello`，则当请求的URL为`/hello/there`不会匹配到`/hello`，而是匹配到`/`。

而绑定了`/hello/`时，则当请求的URL为`/hello/there`会匹配到`/hello/`。符合小惊讶原则。

创建一个处理器和多路复用器，只需要实现ServeHTTP方法即可，因此创建第三方多路复用器是可行的。

HttpRouter是一个高效的轻量级第三方多路复用器。官方的ServeMux的一个缺陷是无法使用变量实现URL模式匹配，比如`/thread/123`的`123`。需要开发者进行复杂的语法分析，HttpRouter帮我们做了这件事情。通过Github可以发现，该package的代码量不多，但是star却非常多，很厉害。



# 第四章 处理请求

介绍处理HTTP请求的相关细节，重点讲述Go是如何处理请求并返回响应的。除此之外，读者还将学会如何从HTML表单中获取数据以及如何使用cookie。

## HTML表单

HTML表单是使用标签`<form>`和`</form>`包围起来的部分，可以包含文本行、文本框、单选按钮、复选框、文件上传等HTML表单元素。

HTML表单可以指定HTTP方法，当提交表单时，会将在表单中输入的数据以键值对的形式记录在请求里（POST方法记录在主体里，GET方法记录在URL），然后以指定的方法发送请求。HTML表单可以指定内容类型(enctype属性)，决定键值对使用何种格式。enctype属性的默认值是application/x-www-form-urlencoded。浏览器至少支持application/x-www-form-urlencoded和multipart/form-data这两种编码方式。

若使用application/x-www-form-urlencoded编码，则顾名思义，和url的百分号编码方式一致。

若使用multipart/form-data编码，则表单中的数据将被转化成一条MIME报文：表单中的每个键值对都构成了这个报文的一部分，并且每个键值对都带有它们各自的内容类型以及内容配置(disposition)。

如何选择编码？若传送的是简单的文本数据，使用URL编码更好，因为这样更简单高效，所需的计算量少。假如需要传送大量数据（如上传文件）那么使用multipart/form-data更好。在需要时，可以使用Base64编码。

## Go与HTML表单
涉及到Request数据结构，参考Go-Package.md

## Go与JSON主体的POST请求

使用HTML表单是发送POST请求的一种方式，使用JSON发送POST请求是另一种方式，这种形式变得越来越常见。

发送JSON数据，可以使用不同的编码方式，比如application/x-www-form-urlencoded或application/json等。

Go语言的ParseForm方法并不会对application/json的编码方式进行解析，因此对于使用application/json编码方式的请求就无法解析出任何数据。**这是个值得思考的细节，我们应该不要想当然地对框架做某种假设，而应该深入文档和底层代码。**

## Go的ResponseWriter

涉及到ResponseWriter数据结构，参考Go-Package.md

## cookie

cookie是一种存储在客户端的、体积较小的信息，这些信息最初都是由服务器通过HTTP响应报文发送的。每当客户端向服务端发送一个HTTP请求时，cookie都会随着请求一同被发送至服务器。cookie的设计本意是要克服HTTP的无状态性，虽然cookie并不是完成这一目的的唯一方法，但它确是最常用的方法之一。

总的来说，cookie可以划分为会话cookie(临时cookie)和持久cookie两种类型，类似超级cookie、第三方cookie、僵尸cookie通常都是持久cookie的变种。

假如Cookie的Value中有空格等特殊字符，需要使用Base64编码。

## Go与Cookie

涉及到Cookie数据结构，参考Go-Package.md

## Go与闪现消息

实现原理通过将MaxAge设置为-1。



# 第五章 内容展示

介绍Go模板引擎，包括text/template库和html/template库。读者将会看到Go提供的各种模板机制，并学会如何使用Go的布局。

在Web应用中，模板引擎会把模板和数据进行合并，生成将要返回给客户端的HTML。

Go的标准模板引擎定义在html/template包当中。

Go模板引擎的工作方式就是对一个模板进行语法分析，接着在执行这个模板的时候，将一个ResponseWriter以及一些数据传递给它。被调用的模板引擎会对传入的已分析模板以及数据进行合并，然后把合并的结果传递给ResponseWriter。

Go的模板拥有一系列丰富多样并且威力强大的动作，这些动作就是一系列指令，它们可以告诉模板以何种方式与数据合并。

除了动作之外，模板还可以包含参数、管道和变量；其中参数用于表示模板中的数据值，管道用于串联起多个参数和函数，至于变量则会作为动作的组件而存在。

Go拥有一系列受限的模板函数。此外，通过创建一个函数映射并将它与模板进行绑定，用户也可以创建出自己的模板函数。

Go的模板引擎可以根据数据所在的位置改变数据的显示方式，这种上下文感知特征能够有效地防御XSS攻击。

人们在设计一个拥有一致外观和使用感受的Web应用时，常常会用到Web布局，Go可以使用嵌套模板来实现Web布局。

# 第六章 存储数据

介绍Go的存储策略。读者将学会如何将数据存储到内存，以及将数据存储到文件系统。

将数据存储到内存，即保存到切片、映射、队列等数据结构中。使用类似Redis的内存数据库也是将数据存储到内存的一种方式，但并不是唯一选择。

将数据存储到文件系统，有多种方式。第一种方式是存储到CSV文件中。第二种方式是使用Go语言特有的gob包。第三种方式是存储到数据库中。在Go中，这三种方式都有对应的包。

当使用关系数据库时，会涉及到复杂的关系，处理起来十分麻烦，可以使用关系映射器简化，也称为ORM。GORM是目前最好用的Go语言的ORM框架，有很多强大的功能。

# 第七章 构建Web服务的方法

介绍构建Web服务的方法，以及处理XML、JSON数据的方法。

Web服务是一个向其他软件程序提供服务的程序，Web服务服务的终端用户是软件程序而不是人类。XML和JSON是Web服务最常使用的数据格式。Web服务有两大风格，分别是SOAP风格和REST风格。

基于SOAP(Simple Object Access Protocol)的Web服务，优点是拥有数量颇丰的拓展可用（以WS-开头），健壮，能够使用WSDL进行明确的描述，拥有内置的错误处理机制，还可以通过UUDI规范发布。缺点是笨重且复杂，XML报文可能会非常冗长导致难以调试，性能较差，所规定的契约有时也会编程一种累赘。

基于REST(Representational state transfer)的Web服务，显得灵活得多。REST不是一种结构，而是一种设计理念。优点是使用JSON这种较为简单的数据格式，性能好，且更简单。

SOAP和REST的区别是功能驱动的，后者是数据驱动的。基于SOAP的Web服务往往是RPC风格的，而REST的Web服务关注的是资源，而HTTP方法是读这些资源执行操作的动词。

很多开发者选择将SOAP用于实现内部应用的企业集成，而REST则用于服务外部以及第三方的开发者。这一策略的优势在于，它最大限度地利用了REST（速度快并且构建简单）以及SOAP（安全并且健壮）这两种技术的优点。

## 基于SOAP的Web服务

SOAP是一种协议。SOAP的HTTP报文首部中，Content-Type为`application/soap+xml`，内容是一个复杂的XML。请求报文的内容是由WSDL生成的SOAP客户端负责生成的，而响应报文则是由WSDL生成的SOAP服务器负责生成。只要WSDL是明确定义的，那么它生成的SOAP客户端通常也是健壮的。这样做的缺点是每次修改服务器，客户端都需要重新生成。可见，基于SOAP的Web服务升级不友好。

## 基于REST的Web服务

REST是一种设计理念，用于设计那些通过标准的几个动作来操纵资源，并以此来进行相互交流的程序。

REST以资源为单位，允许人们通过少数几个称为动词的动作来操纵这些资源。

在使用HTTP协议实现REST服务时，URL将用于表示资源，而HTTP方法则会用作操纵资源的动词。

REST这种设计理念非常适用于那些只执行简单的CURD操作的应用，但是其实REST同样也适用于复杂的服务。当用户需要对资源执行某个任意的动作时，比如激活。我们无法这样写`ACTIVATE /user/456 HTTP/1.1`，但是我们可以使用两种方法来绕过这个问题。

方法一，把过程具体化，或者把动作转化成名词，然后将其用作资源。比如`POST /user/456/activation HTTP/1.1`，报文主体可带相关信息，比如`{"date": "2015-05-15T13:05:05Z"}`。

方法二，将动作转化为资源的属性。比如`PATCH /user/456 HTTP/1.1`，报文主体为`{"active": "true"}`。

## Go与XML和JSON

可以参考官方文档。

# 第八章 应用测试

介绍不同层级的测试方法，包括单元测试、基准测试以及HTTP测试，还简单介绍了几个第三方测试库。



# 第九章 并发

介绍并发特性，学会如何利用并发特性来提高性能。



# 第十章 部署

介绍Web应用的部署方法，包括部署到独立的服务器上、云平台、Docker等。